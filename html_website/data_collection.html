<!DOCTYPE html>
<html>
    <head>
        <title>Data Collection</title>
        <!-- bootstrap css -->
        <link rel="stylesheet" href="./ogistic/css/bootstrap.min.css">
        <!-- style css -->
        <link rel="stylesheet" href="./ogistic/css/style.css">
        <!-- Responsive-->
        <link rel="stylesheet" href="./ogistic/css/responsive.css">
        <!-- fevicon -->
        <link rel="icon" href="./ogistic/images/fevicon.png" type="image/gif" />
        <!-- Scrollbar Custom CSS -->
        <link rel="stylesheet" href="./ogistic/css/jquery.mCustomScrollbar.min.css">
        <!-- Tweaks for older IEs-->
        <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">

        <script src="https://unpkg.com/@vernier/godirect/dist/godirect.min.umd.js"></script>
        <script src="./data.js"></script>
    </head>

    <body onload="Initialize()">
        <div id="display_patient" class="vehicle">
            <form class="patient_info">
                <div class="col-md-12">
                    <h3>Welcome, Patient Name</h3>
                    <h4 style="color:red;">TODO: change input boxes to text - only display, don't let them edit</h4>
                 </div>
                 <div class="col-md-12">
                    <label>Name: </label>
                    <input class="patient_form" placeholder="A " type="text" name="patient_name">
                 </div>
                 <div class="col-md-12">
                    <label> Age: </label>
                    <input class="patient_form" placeholder="21" type="text" name="patient_age">
                 </div>
                 <div class="col-md-12">
                    <label>Date of Birth: </label>
                    <input class="patient_form" placeholder="5/6/23" type="text" name="patient_dob">
                 </div>
                 <div class="col-md-12">
                    <label>Hand Dominance: </label>
                    <input class="patient_form" placeholder="Right" type="text" name="patient_hand_dom">
                 </div>
                 <div class="col-md-12">
                    <button class="get_now">Get Now quote</button>
                 </div>
            </form>
        </div>
        <div id="choose_data_entry" class="data">
            <div class="container">
               <div class="row">
                  <div class="col-md-10 offset-md-1">
                     <div class="titlepage">
                        <h2>Data Collection</h2>
                        <h2 style="font-size:x-large;">Choose Bluetooth or Manual Data Entry</h2>
                        <h3 id="ble_supported">check BLE</h3>
                        <h4 style="color:red;">TODO: once they chose bluetooth, have a button to view instructions</h4>
                    </div>
                  </div>
               </div>
               <div class="row">
                  <div class="col-md-12">
                     <div id='select_collection_method' class="data_main">
                        <div class="data_box blue_colo">
                            <i id="ble_btn"><img src="./ogistic/images/ser1.png" alt="#" onclick="SetCollectionMethod(true);"/></i> 
                            <h4>Bluetooth</h4>
                        </div>
                        <div class="data_box pink_colo">
                            <i id="manual_btn"><img src="./ogistic/images/ser2.png" alt="#" 
                                onclick="SetCollectionMethod(false);"></i> 
                            <h4>Manual</h4>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-12">
                     
             
                     <br>
                     <script onload="">
                        document.getElementById('ble_collection').disabled = !db;
                     </script>
                     <!--if ble is selected-->
                     <div id="ble_collection" class="ble_collection" >
                        <button id="ble_connect"> Connect Device </button>
                        <h3 id="ble_status"> Bluetooth Status... </h3>
                        <h3 id="sensor_status"> Sensor Status... </h3>
                        <button id ="collect_data" onclick="CollectData()">Collect Data</button>
                        <text id="start_time"></text>
                        <text id="end_time"></text>
                        <br>
                        <!--start data collection-->
             
                        <button id="ble_disconnect" onclick="DisconnectDevice()"> Disconnect </button>
                        <br>
             
                        <div id="error"></div>
                        <pre id="output"></pre>
                     </div>

                     <!--if manual is selected-->
                     <div id="manual_collection" class="manual">
                        <form id="manual_entry">
                            <h2>Manual Entry </h2>
                            <div class="manual_entry_row">
                                <div class="manual_entry_column">
                                    <div class="col-md-12">
                                        <h3>Right Hand Measurements</h3>
                                     </div>
                                     <div class="col-md-12">
                                        <label>Trial 1: </label>
                                        <input class="manual_entry_form" placeholder="60" type="text" name="right_t1">
                                     </div>
                                     <div class="col-md-12">
                                        <label>Trial 2: </label>
                                        <input class="manual_entry_form" placeholder="60" type="text" name="right_t2">
                                     </div>
                                     <div class="col-md-12">
                                        <label>Trial 3: </label>
                                        <input class="manual_entry_form" placeholder="60" type="text" name="right_t3">
                                     </div>
                                </div>
                                <div class="manual_entry_column">
                                    <div class="col-md-12">
                                        <h3>Left Hand Measurements</h3>
                                     </div>
                                     <div class="col-md-12">
                                        <label>Trial 1: </label>
                                        <input class="manual_entry_form" placeholder="60" type="text" name="left_t1">
                                     </div>
                                     <div class="col-md-12">
                                        <label>Trial 2: </label>
                                        <input class="manual_entry_form" placeholder="60" type="text" name="left_t2">
                                     </div>
                                     <div class="col-md-12">
                                        <label>Trial 3: </label>
                                        <input class="manual_entry_form" placeholder="60" type="text" name="left_t3">
                                     </div>
                                </div>
                            </div>
                            <input class="manual_entry_form" type="submit" value="Submit">
                        </form>
                     </div>
                  </div>
               </div>
            </div>
         </div>

        <h2 id="ble_supported">check BLE</h2>

        <!--set data collection method-->
        <script>
            let isBLE = false;
            function SetCollectionMethod(flag=false) {
                isBLE = flag;
                if (isBLE) {
                    document.getElementById('ble_collection').style.visibility = 'visible';
                    document.getElementById('manual_collection').remove();
                } else {
                    document.getElementById('manual_collection').style.visibility = 'visible';
                    document.getElementById('ble_collection').remove();
                }

            }
        </script>
        


        <!--bluetooth functions-->
        <script>
            // checks bluetooth capability of browser
            const lbl_ble_supported = document.querySelector('#ble_supported');
            if (navigator.bluetooth) {
                lbl_ble_supported.innerHTML = '<span style="color:green">Bluetooth is Supported on this Browser';
            } else {
                lbl_ble_supported.innerHTML = `<span style="color:red">Bluetooth is Not Supported on this Browser`;
            }

            const btn_connect = document.querySelector('#ble_connect');
            const lbl_ble_status = document.querySelector('#ble_status');
            const lbl_sensor_status = document.querySelector('#sensor_status');

            const lbl_start = document.querySelector('#start_time');
            const lbl_end = document.querySelector('#end_time');
            

            const output = document.querySelector('#output');
            const error = document.querySelector('#error');

            // create array to store data to be saved in the csv file
            let data = [];
            let gdxDevice = "";
            // let sensor = null;

            const ConnectDevice = async() => {
                error.textContent = "";
                
                try {
                  const bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'GDX' }],
                    optionalServices: ['d91714ef-28b9-4f91-ba16-f0d9a604f112']
                  });
                  gdxDevice = await godirect.createDevice(bleDevice,  {open: true, startMeasurements: false});
                  lbl_ble_status.innerHTML = '<span style="color:green">Bluetooth Connected';
                  output.textContent += `\n Connected to `+gdxDevice.name;

                } catch (err) {
                    lbl_ble_status.innerHTML = '<span style="color:red">Bluetooth Not Connected</span>';
                    console.error(err);
                    error.innerText += "\n "+err;
                    if (err.toString().includes('cross-origin')) {
                    error.innerHTML+= '\n<p><b>Are you running in an embedded iframe? Try running this example in its own window.</b></p>'
                    }
                }
            }

            function CollectData() {
                // set up sensor
                const sensor = gdxDevice.getSensor(1);
                if (sensor) {
                  output.textContent = `\n Selected Sensor: ${sensor.name} units: ${sensor.unit}`;
                  sensor.setEnabled(true);
                }

                // clear data arrays
                sensor.values = [];
                data = [];

                // device closes after collection
                
                lbl_sensor_status.innerHTML = '<span style="color:green">Force (N) Sensor Connected';
                
                gdxDevice.start(100);
                lbl_start.innerText = new Date();
                sensor.on('value-changed', (sensor) => {
                    // samples for 5 seconds
                    if (sensor.values.length > 50){
                        // gdxDevice.close();
                        gdxDevice.stop();
                        lbl_end.innerText = new Date();
                    }
                    // log the sensor name, new value and units.
                    console.log(`Sensor: ${sensor.name} value: ${sensor.value} units: ${sensor.unit}`);
                    // add data points to the data array
                    data.push(sensor.value);
                    // output the change to the pre tag
                    output.textContent += `\n Sensor: ${sensor.name} value: ${sensor.value} units: ${sensor.unit}`;
                }); 
            }

            function DisconnectDevice() {
                error.textContent = "";
                gdxDevice.close();
                output.textContent += `\n Disconnected from `+gdxDevice.name;
                gdxDevice = "";
            }

            btn_connect.addEventListener('click', ConnectDevice);

        </script>
    </body>
</html> 