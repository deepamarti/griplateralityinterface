<!DOCTYPE html>
<html lang ="en">

<head>
    <meta charset ="UTF-8">
    <meta http-equiv="X-US-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRaINlab Grip Symmetry Measurement</title>

    <!--StyleSheet and Icon Reference-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/fontawesome.min.css">
    <link rel="stylesheet" href="./aggieimpact_design/css/patientStyle.css">
    <link rel="stylesheet" href="./aggieimpact_design/css/dataStyle.css">

    <!--JQuery Import-->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <!--Firebase Libraries-->
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-database.js"></script> 
    <script type="module" src="firebase.js"></script>
    <script id="FireBaseScript"></script>

    <!--Data Collection Functions-->
    <script src="https://unpkg.com/@vernier/godirect/dist/godirect.min.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="data.js"></script>
    
    <!--patient search functions-->
    <script>
        function filterTable(){
            var input, filter, table, tr, td ,i, txtValue;
            input = document.getElementById('searchingFor');
            filter = input.value.toUpperCase();
            table = document.getElementById('patientTable');
            tr = table.getElementsByTagName('tr');
            for (i=0;i<tr.length;i++)
            {
                td = tr[i].getElementsByTagName('td')[0];
                if (td)
                {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1){
                        tr[i].style.display="";
                    }
                    else{
                        tr[i].style.display="none";
                    }
                }
            }
        }
    </script>
</head>

<body onload="Initialize(); check_BLE_support();">
    <section id="menu">
        <div class="logo">
            <img src="aggieimpact_design/images/BRAIN_Lab_Icon.png" alt="">
        </div>
        <div class="MenuItems">
            <li id="signOut">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#FFFFFF" d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"/></svg>
                <a href="#">Sign Out</a>
            </li>            
        </div>
    </section>

    <section id="interface">
        <div class ="navBar">
            <div class="Profile">
                <p style="margin-right: 15px; color: white;">Welcome, User!</p>
                <img src="aggieimpact_design/images/avatar.jpg" alt="">
            </div>
        </div>
       <div class="syncButton">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#000000" style="width: 4%; margin-left: 1%; margin-right: 1%;" d="M142.9 142.9c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5c0 0 0 0 0 0H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5c7.7-21.8 20.2-42.3 37.8-59.8zM16 312v7.6 .7V440c0 9.7 5.8 18.5 14.8 22.2s19.3 1.7 26.2-5.2l41.6-41.6c87.6 86.5 228.7 86.2 315.8-1c24.4-24.4 42.1-53.1 52.9-83.7c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.2 62.2-162.7 62.5-225.3 1L185 329c6.9-6.9 8.9-17.2 5.2-26.2s-12.5-14.8-22.2-14.8H48.4h-.7H40c-13.3 0-24 10.7-24 24z"/></svg>
            <button class="firebase_button" id="firebaseBtn" type="button" style="width:90%">Sync Data</button>
        </div>
        <div class="searchBar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#000000" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>
            <input type="search" id="searchingFor" placeholder="Patient Lookup" maxlength="20" onkeyup="filterTable()">
        </div>
            
        <div class="board">
            <table id="patientTable">
                <thead>
                    <tr>
                        <td> Patient Name </td>
                        <td> Birth Date </td>
                        <td> Patient Status </td>
                        <td> Choose Patient </td>
                    </tr>
                </thead>
                <tbody id = "patientBody"></tbody>
            </table>
        </div>

        <div class="data_collection" id="data_collection">
            <div class="col-md-12">
               <h2>Data Collection</h2> 
            </div>
            
            <div class="tab">
                <button onClick="SwitchTab(event,'Manual');">Manual Entry</button>
                <button onClick="SwitchTab(event,'Bluetooth');">Bluetooth</button>
            </div>

            <div id="Manual" class="tabcontent">
                <form id="manual_entry">
                    <div class="form_entry_row">
                        <div class="form_entry_column">
                            <div class="col-md-12">
                                <h3>Right Hand Measurements</h3>
                             </div>
                             <div class="col-md-12">
                                <label>Trial 1: </label>
                                <input class="manual_entry_form" type="text" id="man_right_t1">
                             </div>
                             <div class="col-md-12">
                                <label>Trial 2: </label>
                                <input class="manual_entry_form" type="text" id="man_right_t2">
                             </div>
                             <div class="col-md-12">
                                <label>Trial 3: </label>
                                <input class="manual_entry_form" type="text" id="man_right_t3">
                             </div>
                        </div>
                        <div class="form_entry_column">
                            <div class="col-md-12">
                                <h3>Left Hand Measurements</h3>
                             </div>
                             <div class="col-md-12">
                                <label>Trial 1: </label>
                                <input class="manual_entry_form" type="text" id="man_left_t1">
                             </div>
                             <div class="col-md-12">
                                <label>Trial 2: </label>
                                <input class="manual_entry_form" type="text" id="man_left_t2">
                             </div>
                             <div class="col-md-12">
                                <label>Trial 3: </label>
                                <input class="manual_entry_form" type="text" id="man_left_t3">
                             </div>
                        </div>
                    </div>
                    <input class="manual_entry_form" type="submit" value="Submit">
                </form>
            </div>
            <div id="Bluetooth" class="tabcontent">
                <div id="ble_collection" class="ble_collection">
                    <h3 id="ble_supported">check BLE</h3>
                    <div class="col-md-12">
                        <img src="./aggieimpact_design/images/bluetooth.png" alt="#" id="ble_status" 
                        style="height: 45px; width: 45px; padding: 5px; border-radius: 10px; background-color: #ffe26a;"></img>
                        <button id="ble_connect"> Connect Device </button>
                        <button id="ble_disconnect" onclick="DisconnectDevice()"> Disconnect </button>
                    </div>
                    <div class="form_entry_row">
                        <div class="form_entry_column">
                            <div class="col-md-12">
                                <h3>Right Hand Measurements</h3>
                             </div>
                             <div class="col-md-12">
                                <button class="trial_button" id ="ble_right_t1" onclick="currentSample(0); CollectData();"> Trial 1</button>
                             </div>
                             <div class="col-md-12">
                                <button class="trial_button" id ="ble_right_t2" onclick="currentSample(1); CollectData();"> Trial 2</button>
                             </div>
                             <div class="col-md-12">
                                <button class="trial_button" id ="ble_right_t3" onclick="currentSample(2); CollectData();"> Trial 3</button>
                             </div>
                        </div>
                        <div class="form_entry_column">
                            <div class="col-md-12">
                                <h3>Left Hand Measurements</h3>
                             </div>
                             <div class="col-md-12">
                                <button class="trial_button" id ="ble_left_t1" onclick="currentSample(3); CollectData();"> Trial 1</button>
                             </div>
                             <div class="col-md-12">
                                <button class="trial_button" id ="ble_left_t2" onclick="currentSample(4); CollectData();"> Trial 2</button>
                             </div>
                             <div class="col-md-12">
                                <button class="trial_button" id ="ble_left_t3" onclick="currentSample(5); CollectData();"> Trial 3</button>
                             </div>
                        </div>
                        <div class="form_entry_column">
                            <div class="col-md-12">
                                <button class="trial_button" id ="ble_submit" style="width:100%"> Submit</button>
                             </div>
                        </div>
                    </div>
                    <div class="graph_entry_row">
                        <div class="graph_entry_column" style="width:25%;">
                            <div class="col-md-12">
                                <table class="opt_table" id="opt_table" width="100%">
                                    <thead>
                                        <tr>
                                            <td> Time </td>
                                            <td> Force </td>
                                        </tr>
                                    </thead>
                                    <tbody id="opt_sample_table"></tbody>
                                </table>
                                <div class="col-md-12">
                                    <button class="accept_button" id ="accept_button" onclick="Accept()"> <img src="./aggieimpact_design/images/check.png" alt="#" id="ble_status" 
                                        style="height: 45px; width: 45px; padding: 5px; border-radius: 10px; background-color: #abd699;"></img></button>
                                    <button class="reject_button" id ="reject_button" onclick="Reject()"> <img src="./aggieimpact_design/images/cross.png" alt="#" id="ble_status" 
                                        style="height: 45px; width: 45px; padding: 5px; border-radius: 10px; background-color: #ea8a81;"></img></button>
                                 </div>
                             </div>
                        </div>
                        <div class="graph_entry_column" style="width:75%;">
                            <canvas id="chart_sample" style="width:100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!--bluetooth functions-->
    <script>
        const btn_connect = document.querySelector('#ble_connect');
        const ble_status = document.querySelector('#ble_status');

        let gdxDevice = "";
        let sample_data = Array(6);
        let opt_sample_data = Array(6)
        let opt_sample_time = Array(6);
        let current_index = null;
        let right_num_samples = 0;
        let left_num_samples = 0;

        let done_sampling = false;

        const ConnectDevice = async() => {
            try {
              const bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'GDX' }],
                optionalServices: ['d91714ef-28b9-4f91-ba16-f0d9a604f112']
              });
              gdxDevice = await godirect.createDevice(bleDevice,  {open: true, startMeasurements: false});
              ble_status.style.backgroundColor = "#abd699";
              graph_interval = setInterval(updateValue, 100);
              disable_button('ble_connect');
              enable_button('ble_disconnect');
              lock_method_selection();
            } catch (err) {
                console.error(err);
            }
        }

        function CollectData() {
            // set up sensor
            const sensor = gdxDevice.getSensor(1);
            if (sensor) {
              sensor.setEnabled(true);
            }

            // clear data arrays
            done_sampling = false;
            sensor.values = [];
            sample_data[current_index] = [];
            opt_sample_data[current_index] = [];
            force_data = Array(51).fill(NaN);
            opt_data = Array(51).fill(NaN);
            
            gdxDevice.start(100);
            sensor.on('value-changed', (sensor) => {
                // samples for 5 seconds
                if (sensor.values.length > 51){
                    done_sampling = true;
                    gdxDevice.stop();
                    //clearInterval(countdown_interval);
                }
                // log the sensor name, new value and units.
                console.log(`Sensor: ${sensor.name} value: ${sensor.value} units: ${sensor.unit}`);
                // add data points to the data array
                sample_data[current_index].push(sensor.value);
            }); 
        }

        function DisconnectDevice() {
            if (gdxDevice != null) {
                gdxDevice.close();
            }
            gdxDevice = "";
            ble_status.style.backgroundColor = "#ffe26a";
            clearInterval(graph_interval);
            enable_button('ble_connect');
            disable_button('ble_disconnect');
        }

        btn_connect.addEventListener('click', ConnectDevice);

        function currentSample(index) {
            // keeps a variable with the index of the current sample
            current_index = index;
        }

    </script>

    <!--graphing functions-->
    <script>
        let graph_interval = null;
        const time = Array.from(
            { length: 51 },
            (value, index) => Math.round(index * 0.1 *10)/10);
        let force_data = [];
        let opt_data = Array(51).fill(NaN);
        let color = Array(51).fill("rgba(0,0,255,1.0)");
        let chart = new Chart.Line("chart_sample", {
        data: {
            labels: time,
            datasets: [{
                fill: false,
                lineTension: 0,
                backgroundColor: "#75c9b7",
                borderColor: "#75c9b7",
                borderWidth: 1,
                order: 1,
                data: force_data
            }, {
                fill: false,
                lineTension: 0,
                backgroundColor: "#ea8a81",
                borderColor: "#ea8a81",
                borderWidth: 1,
                order: 0,
                data: opt_data
            }]
        },
        options: {
            legend: {display: false},
            scales: {
            yAxes: [{ticks: {min: -1, max:600}}],
            },
            tooltips: {enabled: false}
        }
        });

        function updateValue() {
            force_data = sample_data[current_index];
            if (done_sampling == true) {
                opt_sample_time[current_index]= FindOptSample(force_data);
                for (let i=0;i<5;i++){
                    opt_data[opt_sample_time[current_index][i]*10] = force_data[opt_sample_time[current_index][i]*10];
                    opt_sample_data[current_index][i] = opt_data[opt_sample_time[current_index][i]*10];
                    AddToOptTable(opt_sample_time[current_index][i], opt_sample_data[current_index][i]);
                }
                // disable everything except for the accept reject buttons
                WaitForAcceptReject();
                //
                done_sampling=false;

                // do accept reject here, and increment counters
                // disable buttons in accept reject listeners
                
            }
            chart.data.datasets[0].data = force_data;
            chart.data.datasets[1].data = opt_data;
            chart.update();
        }
        
    </script>

    <!--accept/reject-->
    <script>
        function Accept() {
            AcceptTrial(current_index);
        }

        function Reject() {
            ClearOptTable();
            sample_data[current_index] = [];
            opt_sample_data[current_index] = [];
            opt_sample_time[current_index] = [];
            opt_data = [];
            updateValue();
        }
    </script>

    <!--firebase function-->
    <script type="module">
    import {AddBLEToDatabase} from "./firebase.js";
        let dBtn = document.getElementById("ble_submit");
        dBtn.addEventListener('click', StoreData);
        function StoreData() {
            AddBLEToDatabase(sample_data, opt_sample_data, opt_sample_time);
            disable_button("ble_submit");
        }

    </script>
    

</body>

</html>
